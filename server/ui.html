<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Todo App (QA SUT)</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 720px; margin: 40px auto; }
      input, button { padding: 8px; }
      li { margin: 8px 0; }
      .done { text-decoration: line-through; }
      .row { display: flex; gap: 8px; align-items: center; }
      .row > * { flex: 0 0 auto; }
      .row input { flex: 1 1 auto; }
      pre { background: #f4f4f4; padding: 12px; overflow: auto; }
    </style>
  </head>
  <body>
    <h1>Todo App</h1>

    <h3>Login</h3>
    <div class="row">
      <input id="email" placeholder="email" value="qa@example.com" />
      <input id="password" placeholder="password" value="password123" />
      <button id="login">Login</button>
    </div>
    <p>UserId: <span id="userId">-</span></p>

    <h3>Todos</h3>
    <div class="row">
      <input id="newTodo" placeholder="Nova tarefa" />
      <button id="add">Adicionar</button>
      <button id="refresh">Atualizar</button>
    </div>

    <ul id="list"></ul>

    <h3>Debug</h3>
    <pre id="debug"></pre>

    <script>
      let userId = null;

      const $ = (id) => document.getElementById(id);
      const debug = (obj) => ($("debug").textContent = JSON.stringify(obj, null, 2));

      async function api(path, options = {}) {
        const headers = options.headers || {};
        if (userId) headers["x-user-id"] = String(userId);
        headers["content-type"] = "application/json";
        const res = await fetch(path, { ...options, headers });
        if (res.status === 204) return null;
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw data;
        return data;
      }

      async function loadTodos() {
        const todos = await api("/api/todos");
        const ul = $("list");
        ul.innerHTML = "";
        todos.forEach((t) => {
          const li = document.createElement("li");
          li.className = t.done ? "done" : "";
          li.textContent = `${t.id}: ${t.title}`;
          li.addEventListener("click", async () => {
            const updated = await api(`/api/todos/${t.id}`, {
              method: "PATCH",
              body: JSON.stringify({ done: !t.done }),
            });
            debug(updated);
            await loadTodos();
          });
          ul.appendChild(li);
        });
        debug(todos);
      }

      $("login").onclick = async () => {
        try {
          const data = await api("/auth/login", {
            method: "POST",
            body: JSON.stringify({ email: $("email").value, password: $("password").value }),
          });
          userId = data.userId;
          $("userId").textContent = userId;
          debug(data);
          await loadTodos();
        } catch (e) {
          debug(e);
          alert("Login falhou");
        }
      };

      $("add").onclick = async () => {
        const title = $("newTodo").value.trim();
        if (!title) return;
        const created = await api("/api/todos", { method: "POST", body: JSON.stringify({ title }) });
        $("newTodo").value = "";
        debug(created);
        await loadTodos();
      };

      $("refresh").onclick = loadTodos;
    </script>
  </body>
</html>
